# Проектная работа спринта 3

## Задание 1. Анализ и проектирование

### Подзадание 1.1. Описание текущей системы

#### Анализ предметной области
Доменная модель: [domain-model-strategic.puml](./docs/diagrams/domain/domain-model-strategic.puml)
> Данная модель отражает область автоматизации текущей системой Smart Home, т.к. диаграмма относится к заданию описания текущей системы.

#### Требования
- Пользователи могут удалённо включать/выключать отопление в своих домах.
- Пользователи могут устанавливать необходимую температуру отопления.
- Система автоматически поддерживает заданную температуру, регулируя подачу тепла.
- Пользователи могут просматривать текущую температуру в своих домах через веб-интерфейс.

#### Архитектура
Диаграмма С4 System Context: [c4-context.puml](./docs/diagrams/C4/c4-context.puml)

Система представляет собой монолитное приложение на языке Java. Взаимодействие с системой осуществляется посредством обращений к REST API. Для хранения данных используется СУБД PostgreSQL.

Ограничения текущей архитектуры:

- Все компоненты системы (обработка запросов, бизнес-логика, работа с данными) находятся в рамках одного приложения.
- Все вызовы к API являются синхронными (блокирующими).
- Масштабирование ограничено, т.к. нет возможности масштабировать определенную функциональность приложения отдельно.
- Для обновления требуется остановка всего приложения, что влечет простой в работе.

### Подзадание 1.2. Архитектура микросервисов. Новая экосистема.

#### Требования
- Система позволяет управлять отоплением, включать и выключать свет, запирать и отпирать автоматические ворота, удаленно наблюдать за домом и будущее неуточненное поведение.
- Система поддерживает подключение к экосистеме устройств партнеров по стандартным протоколам.
- Пользователь может просматривать телеметрию.
- Пользователь может настраивать сценарии работы. Пользователь может программировать систему для управления различными модулями в соответствии со своими потребностями.

#### Архитектура

Диаграммы:
- [С4 Container](./docs/diagrams/C4/c4-container.puml)
- [С4 Component](./docs/diagrams/C4/c4-component.puml)

Особенности:
1. Предполагается развертывание системы в облаке для минимизации расходов. 
2. Взаимодействие между сервисами происходит синхронно. Это сделано для того, чтобы команда не была отправлена модулю в неподходящий момент, например: пользователь хочет открыть ворота, но сервис коммуникации с управляющими модулями был недоступен. Пользователь открыл и закрыл ворота в ручном режиме, а через некоторое время, когда работоспособность сервиса была восстановлена, система отправила команду на открытие ворот, хотя этого уже не требовалось (в результате чего ворота остались открыты пока владельцы отсутствовали дома). Также, Kafka не предоставляет exactly-once гарантии доставки (за исключением Kafka Streams), что также может приводить к дублированию команд и несвоевременной их обработке.
3. Инициатором установки соединения между управляющим модулем и сервером является управляющий модуль. Это дает возможность не хранить IP адрес управляющего модуля и позволяет избежать проблем с firewall на точках доступа у клиентов. Коммуникация с управляющими модулями выполняется через WebSocket. 
4. Микросервисы управления освещением и управления автоматическими воротами по сути являются драйверами к устройствам соответствующего типа, через которые подаются команды. Они инкапсулируют логику по взаимодействию с устройствами. Для того чтобы добавить поддержку нового типа устройств нужно добавить новый микросервис (а не изменять сервис Управления устройствами, где в соответствии с описанием задания присутствует эндпоинт по подаче команд).
5. Микросервис Smart Home Legacy Kafka ACL добавлен только в демонстрационных целях. Это описано в комментарии подзадания 2.1.
6. Дома относятся к микросервису управления устройствами, т.к. группируют устройства.

### Подзадание 1.3. ER-диаграмма

[ERD](./docs/diagrams/erd.puml)

### Подзадание 1.4. Создание и документирование API

- [Публичный REST API](./public-api.yaml) - описаны интерфейсы микросервисов управления устройствами, телеметрии, управления отоплением.
- [Публичный Async API](./public-async-api.yaml) - описаны интерфейсы асинхронного взаимодействия через WebSocket с микросервисами коммуникации с управляющими модулями и телеметрии.

## Задание 2. Разработка MVP

> Для выполнения требования задания 2.1. "_Взаимодействие между микросервисами и монолитом будет осуществляться через шину данных Kafka_ ..." взаимодействие между ACL и legacy системой будет происходить через Kafka. Чтобы не изменять код legacy системы (в части приема сообщений) перед ней добавлен сервис преобразования сообщений kafka в вызовы RESTинтерфейса. Данное решение является **демонстрационным** (не целевым), т.к. демонстрирует взаимодействие сервисов через шину. Целевое решение подразумевает коммуникацию через REST интерфейс в соответствии с пунктом 2. особенностей архитектуры из подзадания 1.2.

> В файле публичного REST API описаны эндпоинты `/device/*` и `/house/*` отвечающие за создание и изменение соответствующих сущностей, из-за отсутствия времени сервис для них не был реализован.

Что было выполнено:
1. Настроена шина данных Kafka.
2. Настроена СУБД Postgre SQL.
3. Настроен API Gateway Kong.<br/>
4. Настроен Swagger UI для просмотра и взаимодействия с публичным REST API системы.
5. Реализован сервис отправки команд управляющим модулям `smart-home-communication`.
6. Реализован сервис приема и просмотра телеметрии `smart-home-telemetry`.
7. Реализован сервис управления отоплением `smart-home-monolith-acl`. Данный сервис выступает как ACL между новой системой и монолитом.
8. Реализован сервис конвертации Kafka сообщений от `smart-home-monolith-acl` в вызовы REST API монолита `smart-home-monolith-kafka-acl`.

### Запуск/остановка системы
```sh
# Запуск системы
docker compose up

# Остановка системы
docker compose down
```

### Информация о сервисах

#### API Gateway Kong
Доступен по адресу http://localhost:8000. 
> В docker-compose.yaml используется адресация по ip из-за проблем с разрешением доменных имен контейнеров в WSL. 

#### Swagger UI
Доступен по адресу http://localhost:8000/public/api/swagger/ .

#### Сервис отправки команд управляющим модулям
Принимает команды через внутренний REST интерфейс и передает их управляющим модулям через WebSocket. Инициатором установки соединения являются управляющие модули. Вызовы к REST API сервиса не проходит через API Gateway, т.к. их выполняют микросервисы системы. Взаимодействие с сервисом осуществляется следующим образом:
1. Эмулируется подключение управляющего модуля путем установки соединения с `ws://localhost:8000/ws/command?device_sn=<SERIAL_NUMBER>` через любой WebSocket клиент. SERIAL_NUMBER - серийный номер устройства и он может быть любым.
2. Вызывается API для отправки команды подключившемуся модулю.
    ```sh
    curl -X POST -H "Content-Type: application/json" -d "{\"temperature\": 20.5}" http://localhost:8084/api/command/<SERIAL_NUMBER>
    ```
    Значение `SERIAL_NUMBER` должно совпадать со значением из первого пункта.

#### Сервис приема и просмотра телеметрии

Принимает телеметрию от управляющих модулей. Инициатором установки соединения являются управляющие модули. Взаимодействие с сервисом осуществляется следующим образом:
1. Эмулируется подключение управляющего моделя путем установки соединения с `ws://localhost:8000/ws/telemetry?device_sn=<SERIAL_NUMBER>` через любой WebSocket клиент. SERIAL_NUMBER - серийный номер устройства и он может быть любым.
2. WebSocket клиент отправляет json документ с телеметрией. Например: `{"temperature": 20.5}`
3. Сервис принимает телеметрию и записывает ее в БД.
4. Для просмотра телеметрии используется путь `/telemetry/{deviceId}`.
    ```sh
    curl -X GET "http://localhost:8000/api/telemetry/<SERIAL_NUMBER>?from=2024-09-23T12:00:00&to=2024-09-23T18:00:00"
    ```
    > Время нужно указывать в UTC.

#### Cервис управления отоплением

Отвечает за управление отоплением. Является ACL между новой системой и существующим монолитом. Для взаимодействия используется путь `/heating/*`.
> Т.к. монолит не предоставляет эндпоинтов по регистрации новых устройств, это необходимо делать через SQL запросы. При запуске сервиса автоматически регистрируется тестовое устройство с ID `990101`, поэтому для тестов можно использовать этот идентификатор.

```sh
curl -X POST "http://localhost:8000/api/heating/990101/temperature?temperature=20.5"
```